<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel ‚Äì CorelTech</title>

  <!-- Bootstrap 5 (sin espacios al final) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts: Inter (limpia y moderna) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Iconos de Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --corel-primary: #0d6efd;
      --corel-secondary: #6f42c1;
      --corel-success: #198754;
      --corel-bg: #f8f9fa;
      --corel-card: #ffffff;
      --corel-border: #dee2e6;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--corel-bg);
      color: #212529;
      min-height: 100vh;
    }

    /* Navbar con gradiente */
    .navbar {
      background: linear-gradient(135deg, var(--corel-primary), var(--corel-secondary));
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .nav-link {
      opacity: 0.9;
    }

    /* Tarjetas generales */
    .card {
      border: 1px solid var(--corel-border);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .card-header {
      background-color: var(--corel-primary);
      color: white;
      font-weight: 600;
      border-radius: 12px 12px 0 0 !important;
    }

    /* Bot√≥n principal */
    .btn-corel {
      background: linear-gradient(135deg, var(--corel-primary), var(--corel-secondary));
      color: white;
      font-weight: 600;
      border: none;
    }

    /* Atajos r√°pidos */
    .btn-shortcut {
      font-size: 0.9rem;
      padding: 12px;
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 1px dashed var(--corel-border);
      border-radius: 10px;
      transition: all 0.2s;
    }
    .btn-shortcut:hover {
      background-color: #f1f3f5;
      border-color: var(--corel-primary);
      color: var(--corel-primary);
    }
    .btn-shortcut i {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    /* Estad√≠sticas */
    .stat-card {
      text-align: center;
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--corel-primary);
    }
    .stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }

    /* Footer */
    .footer {
      margin-top: 60px;
      text-align: center;
      color: #6c757d;
      font-size: 0.9rem;
      padding: 20px 0;
    }

    /* Listas interactivas */
    .list-group-item-action {
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Navbar superior -->
  <nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-cpu"></i> CorelTech Panel
      </a>
      <div class="ms-auto">
        <span class="text-white small">
          <i class="bi bi-person-circle"></i> 
          <span id="user-email">cargando...</span>
        </span>
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- Encabezado principal -->
    <div class="text-center mb-4">
      <h1 class="fw-bold">üõ†Ô∏è Panel T√©cnico Centralizado</h1>
      <p class="text-muted">Gesti√≥n avanzada de casos, clientes y mantenimiento</p>
    </div>

    <!-- Atajos r√°pidos -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-lightning"></i> Acciones R√°pidas</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2">
            <button class="btn btn-light w-100 btn-shortcut" onclick="window.location.href='/app/nuevo-caso.html'">
              <i class="bi bi-file-earmark-plus"></i>
              Nuevo Caso
            </button>
          </div>
          <div class="col-md-2">
            <button class="btn btn-light w-100 btn-shortcut" onclick="buscarCliente()">
              <i class="bi bi-search"></i>
              Buscar Cliente
            </button>
          </div>
          <div class="col-md-2">
            <button class="btn btn-light w-100 btn-shortcut" onclick="window.location.href='/app/casos.html'">
              <i class="bi bi-journal-text"></i>
              Historial de Casos
            </button>
          </div>
          <div class="col-md-2">
            <button class="btn btn-light w-100 btn-shortcut" onclick="window.location.href='/app/mantenimiento.html'">
              <i class="bi bi-tools"></i>
              Mantenimiento
            </button>
          </div>
          <div class="col-md-2">
            <button class="btn btn-light w-100 btn-shortcut" onclick="window.location.href='/app/inventario.html'">
              <i class="bi bi-pc-display"></i>
              Inventario
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- B√∫squeda de cliente -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="bi bi-person-lines-fill"></i> Buscar Cliente</h5>
      </div>
      <div class="card-body">
        <div class="input-group">
          <input 
            type="text" 
            id="cliente-id-buscar" 
            class="form-control" 
            placeholder="Ingresa el ID del cliente (ej: V-12345678)"
            maxlength="15"
          >
          <button class="btn btn-primary" type="button" onclick="abrirExpediente()">
            <i class="bi bi-search"></i> Buscar
          </button>
        </div>
        <small class="text-muted mt-2 d-block">El sistema mostrar√° el historial t√©cnico completo</small>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="stat-value" id="total-casos">0</div>
            <div class="stat-label">Casos Totales</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="stat-value" id="clientes-unicos">0</div>
            <div class="stat-label">Clientes</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="stat-value" id="equipos-registrados">0</div>
            <div class="stat-label">Equipos</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="stat-value" id="proximos-mantenimientos">0</div>
            <div class="stat-label">Pr√≥ximos Mantenimientos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gr√°fico de actividad -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="bi bi-graph-up"></i> Actividad Mensual</h5>
      </div>
      <div class="card-body">
        <canvas id="grafico-casos" height="100"></canvas>
      </div>
    </div>

    <!-- √öltimos casos -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> √öltimos Casos</h5>
        <a href="/app/casos.html" class="btn btn-sm btn-outline-primary">Ver todos</a>
      </div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush" id="lista-ultimos-casos">
          <li class="list-group-item text-center text-muted">Cargando...</li>
        </ul>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>¬© 2025 CorelTech ‚Äì Plataforma t√©cnica profesional</p>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="/firebase-config.js"></script>
  <script src="/app/js/auth.js"></script>

  <script>
    // ==========================================
    // ‚úÖ 1. Verificar autenticaci√≥n y cargar datos
    // Si no hay usuario, redirigir a login
    // ==========================================
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '/app/login.html';
        return;
      }
      // Mostrar solo el nombre del correo (antes de @)
      document.getElementById("user-email").textContent = user.email.split('@')[0];
      
      // Cargar datos del panel
      await cargarEstadisticas();
      await cargarUltimosCasos();
      await cargarGrafico();
    });

    // ==========================================
    // ‚úÖ 2. Foco en campo de b√∫squeda
    // Al hacer clic en "Buscar Cliente", enfocar el input
    // ==========================================
    function buscarCliente() {
      document.getElementById("cliente-id-buscar").focus();
    }

    // ==========================================
    // ‚úÖ 3. Abrir expediente del cliente
    // Busca en Firestore si existe, si no, pregunta si crear nuevo caso
    // ==========================================
    async function abrirExpediente() {
      const input = document.getElementById("cliente-id-buscar");
      const id = input.value.trim().toUpperCase();
      
      if (!id) {
        alert("Por favor, ingresa un ID de cliente.");
        input.focus();
        return;
      }

      try {
        const db = firebase.firestore();
        const doc = await db.collection("clientes").doc(id).get();

        if (doc.exists) {
          // Cliente existe ‚Üí abrir expediente
          window.location.href = `/app/expediente.html?cliente=${id}`;
        } else {
          // Cliente no existe ‚Üí ofrecer crear caso
          const crear = confirm(`Cliente no encontrado. ¬øCrear nuevo caso para ${id}?`);
          if (crear) {
            window.location.href = `/app/nuevo-caso.html?cliente=${id}`;
          }
        }
      } catch (error) {
        console.error("Error al buscar cliente:", error);
        alert("Error al conectar con la base de datos. Intenta de nuevo.");
      }
    }

    // ==========================================
    // ‚úÖ 4. Cargar estad√≠sticas desde Firebase
    // Muestra: casos, clientes, equipos y mantenimientos pendientes
    // ==========================================
    async function cargarEstadisticas() {
      const db = firebase.firestore();
      try {
        const [casosSnap, clientesSnap, equiposSnap] = await Promise.all([
          db.collection("casos").get(),
          db.collection("clientes").get(),
          db.collection("equipos").get()
        ]);

        let mantenimientos = 0;
        const seisMesesAtras = new Date();
        seisMesesAtras.setMonth(seisMesesAtras.getMonth() - 6);

        clientesSnap.docs.forEach(doc => {
          const data = doc.data();
          const ultimaFecha = data.ultimoServicio?.toDate();
          if (ultimaFecha && ultimaFecha < seisMesesAtras) {
            mantenimientos++;
          }
        });

        // Actualizar elementos en pantalla
        document.getElementById("total-casos").textContent = casosSnap.size;
        document.getElementById("clientes-unicos").textContent = clientesSnap.size;
        document.getElementById("equipos-registrados").textContent = equiposSnap.size;
        document.getElementById("proximos-mantenimientos").textContent = mantenimientos;

      } catch (error) {
        console.error("Error cargando estad√≠sticas:", error);
      }
    }

    // ==========================================
    // ‚úÖ 5. Cargar √∫ltimos 5 casos
    // Muestra lista con enlace a informe
    // ==========================================
    async function cargarUltimosCasos() {
      const db = firebase.firestore();
      const lista = document.getElementById("lista-ultimos-casos");
      lista.innerHTML = '<li class="list-group-item text-center text-muted">Cargando...</li>';

      try {
        const snapshot = await db.collection("casos")
          .orderBy("fechaSolicitud", "desc")
          .limit(5)
          .get();

        lista.innerHTML = '';
        if (snapshot.empty) {
          lista.innerHTML = '<li class="list-group-item text-center text-muted">No hay casos registrados.</li>';
        } else {
          snapshot.forEach(doc => {
            const data = doc.data();
            const fecha = data.fechaSolicitud?.toDate().toLocaleDateString() || 'N/A';
            const clienteId = data.clienteId || 'Sin cliente';
            const casoId = data.casoId || 'Sin ID';

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <div>
                <strong>${casoId}</strong> - ${clienteId}
                <br><small class="text-muted">${fecha}</small>
              </div>
              <button class="btn btn-sm btn-outline-info" onclick="verInforme('${casoId}')">
                <i class="bi bi-file-earmark-text"></i>
              </button>
            `;
            lista.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Error cargando √∫ltimos casos:", error);
        lista.innerHTML = '<li class="list-group-item text-center text-danger">Error al cargar datos.</li>';
      }
    }

    // ==========================================
    // ‚úÖ 6. Redirigir a informe t√©cnico
    // ==========================================
    function verInforme(casoId) {
      window.location.href = `/app/informe.html?id=${casoId}`;
    }

    // ==========================================
    // ‚úÖ 7. Gr√°fico de casos por mes (√∫ltimos 6 meses)
    // Usa Chart.js para mostrar tendencia
    // ==========================================
    async function cargarGrafico() {
      const db = firebase.firestore();
      const data = {};
      const now = new Date();
      const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 5, 1);

      try {
        const snapshot = await db.collection("casos").get();
        snapshot.forEach(doc => {
          const fecha = doc.data().fechaSolicitud?.toDate();
          if (fecha && fecha >= sixMonthsAgo) {
            const mes = fecha.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
            data[mes] = (data[mes] || 0) + 1;
          }
        });

        // Generar 6 meses desde hoy hacia atr√°s
        const meses = Array.from({ length: 6 }, (_, i) => {
          const d = new Date();
          d.setMonth(d.getMonth() - 5 + i);
          return d.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
        });

        const valores = meses.map(mes => data[mes] || 0);

        const ctx = document.getElementById('grafico-casos').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: meses,
            datasets: [{
              label: 'Casos por mes',
              data: valores,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      } catch (error) {
        console.error("Error al generar gr√°fico:", error);
      }
    }
  </script>
</body>
</html>