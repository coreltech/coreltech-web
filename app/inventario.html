<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario T√©cnico ‚Äì CorelTech</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      color: #212529;
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .equipo-item {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
    }
    .equipo-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .badge {
      font-size: 0.8rem;
    }
    .no-print {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      text-align: center;
      width: 90%;
      max-width: 500px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body class="p-4">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold">üóÑÔ∏è Inventario T√©cnico</h1>
      <button class="btn btn-secondary" onclick="window.history.back()">‚Üê Volver</button>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5>üîç Filtros de B√∫squeda</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Cliente</label>
            <input type="text" id="filtro-cliente" class="form-control" placeholder="V-12345678">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Tipo de Equipo</label>
            <select id="filtro-tipo" class="form-select">
              <option value="">Todos</option>
              <option value="pc-clon">PC Clon</option>
              <option value="marca">PC de Marca</option>
              <option value="laptop">Laptop</option>
              <option value="servidor">Servidor</option>
              <option value="router">Router</option>
              <option value="switch">Switch</option>
              <option value="impresora">Impresora</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Sistema Operativo</label>
            <select id="filtro-so" class="form-select">
              <option value="">Todos</option>
              <option value="windows10">Windows 10</option>
              <option value="windows11">Windows 11</option>
              <option value="linux">Linux</option>
              <option value="macos">macOS</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">RAM</label>
            <select id="filtro-ram" class="form-select">
              <option value="">Toda</option>
              <option value="4 GB">4 GB</option>
              <option value="8 GB">8 GB</option>
              <option value="16 GB">16 GB</option>
              <option value="32 GB">32 GB</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar Filtros</button>
        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">Limpiar</button>
        <button class="btn btn-success float-end" onclick="exportarAExcel()">
          <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
        </button>
      </div>
    </div>

    <!-- Lista de Equipos -->
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5>üñ•Ô∏è Equipos Registrados</h5>
      </div>
      <div class="card-body">
        <div id="lista-equipos">
          <p class="text-muted">Cargando inventario...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones (no se imprimen) -->
  <div class="no-print">
    <button onclick="window.history.back()" class="btn btn-secondary">‚Üê Volver</button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="/firebase-config.js"></script>
  <script src="/app/js/auth.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    let todosLosEquipos = [];

    // Cargar inventario al iniciar
    window.onload = async () => {
      const db = firebase.firestore();
      const snapshot = await db.collection("equipos").get();
      const clientesSnapshot = await db.collection("clientes").get();
      const clientes = {};
      clientesSnapshot.forEach(doc => {
        clientes[doc.id] = doc.data().nombre;
      });

      todosLosEquipos = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          ...data,
          nombreCliente: clientes[data.clienteId] || "Cliente no encontrado"
        };
      });
      mostrarEquipos(todosLosEquipos);
    };

    // Mostrar equipos
    function mostrarEquipos(equipos) {
      const lista = document.getElementById("lista-equipos");
      lista.innerHTML = '';
      if (equipos.length === 0) {
        lista.innerHTML = '<p class="text-muted">No se encontraron equipos.</p>';
        return;
      }
      equipos.forEach(eq => {
        const div = document.createElement("div");
        div.className = "equipo-item";
        div.innerHTML = `
          <div class="d-flex justify-content-between">
            <h6>${eq.tipo} (${eq.serial})</h6>
            <span class="badge bg-primary">${eq.ram}</span>
          </div>
          <p><strong>Cliente:</strong> ${eq.nombreCliente} (${eq.clienteId})</p>
          <p><strong>Marca/Modelo:</strong> ${eq.marca || 'N/A'} ${eq.modelo || 'N/A'}</p>
          <p><strong>SO:</strong> ${eq.sistemaOperativo || 'N/A'}</p>
          <p><strong>Discos:</strong></p>
          <ul>
            ${eq.discos?.map(d => `<li>${d.tipo} ${d.capacidad}${d.particion ? ' ('+d.particion+')' : ''}</li>`).join('') || '<li>No especificado</li>'}
          </ul>
          <div class="text-muted small">
            Creado por: ${eq.creadoPor.split('@')[0]} | 
            √öltima modificaci√≥n: ${new Date().toLocaleDateString()}
          </div>
        `;
        lista.appendChild(div);
      });
    }

    // Aplicar filtros
    function aplicarFiltros() {
      const cliente = document.getElementById("filtro-cliente").value.trim().toUpperCase();
      const tipo = document.getElementById("filtro-tipo").value;
      const so = document.getElementById("filtro-so").value;
      const ram = document.getElementById("filtro-ram").value;

      let filtrados = [...todosLosEquipos];

      if (cliente) {
        filtrados = filtrados.filter(e => e.clienteId.includes(cliente) || e.nombreCliente.toUpperCase().includes(cliente));
      }
      if (tipo) {
        filtrados = filtrados.filter(e => e.tipo === tipo);
      }
      if (so) {
        filtrados = filtrados.filter(e => e.sistemaOperativo === so);
      }
      if (ram) {
        filtrados = filtrados.filter(e => e.ram === ram);
      }

      mostrarEquipos(filtrados);
    }

    // Limpiar filtros
    function limpiarFiltros() {
      document.getElementById("filtro-cliente").value = '';
      document.getElementById("filtro-tipo").value = '';
      document.getElementById("filtro-so").value = '';
      document.getElementById("filtro-ram").value = '';
      mostrarEquipos(todosLosEquipos);
    }

    // Exportar a Excel
    function exportarAExcel() {
      const data = todosLosEquipos.map(eq => ({
        'Serial': eq.serial,
        'Tipo': eq.tipo,
        'Cliente ID': eq.clienteId,
        'Cliente': eq.nombreCliente,
        'Marca': eq.marca,
        'Modelo': eq.modelo,
        'RAM': eq.ram,
        'Sistema Operativo': eq.sistemaOperativo,
        'Discos': eq.discos?.map(d => `${d.tipo} ${d.capacidad}${d.particion ? ' ('+d.particion+')' : ''}`).join(', ') || '',
        'Estado': eq.estado,
        'Creado por': eq.creadoPor.split('@')[0]
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Inventario T√©cnico");
      XLSX.writeFile(wb, `inventario-coreltech-${new Date().toISOString().split('T')[0]}.xlsx`);
    }
  </script>
</body>
</html>