<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üóÑÔ∏è Inventario T√©cnico ‚Äì CorelTech</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      color: #212529;
    }

    /* Tarjeta general */
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Item de equipo */
    .equipo-item {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      transition: box-shadow 0.2s;
    }
    .equipo-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Badge */
    .badge {
      font-size: 0.8rem;
    }

    /* Botones flotantes (m√≥vil) */
    .no-print {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      z-index: 1000;
      text-align: center;
      width: 90%;
      max-width: 500px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    /* Footer */
    footer {
      margin-top: 60px;
      text-align: center;
      color: #6c757d;
      font-size: 0.9rem;
    }
  </style>
</head>
<body class="p-4">
  <div class="container py-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold">üóÑÔ∏è Inventario T√©cnico</h1>
      <a href="/app/index.html" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5>üîç Filtros de B√∫squeda</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Cliente (ID o nombre)</label>
            <input type="text" id="filtro-cliente" class="form-control" placeholder="V-12345678">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Tipo de Equipo</label>
            <select id="filtro-tipo" class="form-select">
              <option value="">Todos</option>
              <option value="pc-clon">PC Clon</option>
              <option value="marca">PC de Marca</option>
              <option value="laptop">Laptop</option>
              <option value="servidor">Servidor</option>
              <option value="router">Router / Firewall</option>
              <option value="switch">Switch</option>
              <option value="impresora">Impresora</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Sistema Operativo</label>
            <select id="filtro-so" class="form-select">
              <option value="">Todos</option>
              <option value="windows10">Windows 10</option>
              <option value="windows11">Windows 11</option>
              <option value="linux">Linux</option>
              <option value="macos">macOS</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">RAM</label>
            <select id="filtro-ram" class="form-select">
              <option value="">Toda</option>
              <option value="4 GB">4 GB</option>
              <option value="8 GB">8 GB</option>
              <option value="16 GB">16 GB</option>
              <option value="32 GB">32 GB</option>
              <option value="64 GB">64 GB</option>
            </select>
          </div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-primary" onclick="aplicarFiltros()">
            <i class="bi bi-funnel"></i> Aplicar Filtros
          </button>
          <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
            <i class="bi bi-eraser"></i> Limpiar
          </button>
          <button class="btn btn-success ms-auto" onclick="exportarAExcel()">
            <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
          </button>
        </div>
      </div>
    </div>

    <!-- Lista de Equipos -->
    <div class="card">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üñ•Ô∏è Equipos Registrados</h5>
        <span class="badge bg-secondary" id="contador-equipos">0</span>
      </div>
      <div class="card-body">
        <div id="lista-equipos">
          <p class="text-muted text-center">Cargando inventario...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones flotantes (m√≥vil) -->
  <div class="no-print d-flex justify-content-center gap-2">
    <a href="/app/index.html" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i>
    </a>
    <button class="btn btn-success btn-sm" onclick="exportarAExcel()">
      <i class="bi bi-file-earmark-excel"></i>
    </button>
  </div>

  <!-- Footer -->
  <footer class="container mt-5">
    <p class="text-center">¬© 2025 CorelTech ‚Äì Inventario t√©cnico profesional.</p>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="/firebase-config.js"></script>
  <script src="/app/js/auth.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    // ==========================================
    // ‚úÖ 1. Variable global: todos los equipos
    // ==========================================
    let todosLosEquipos = [];

    // ==========================================
    // ‚úÖ 2. Verificar autenticaci√≥n al cargar
    // Evita redirecciones incorrectas
    // ==========================================
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        // Si no est√° autenticado, redirigir a login
        window.location.href = '/app/login.html';
        return;
      }
      // Si est√° autenticado, cargar el inventario
      await cargarInventario();
    });

    // ==========================================
    // ‚úÖ 3. Cargar inventario desde Firebase
    // ==========================================
    async function cargarInventario() {
      try {
        const db = firebase.firestore();
        
        // Obtener todos los equipos
        const snapshot = await db.collection("equipos").get();
        
        // Obtener nombres de clientes para mostrarlos
        const clientesSnapshot = await db.collection("clientes").get();
        const clientes = {};
        clientesSnapshot.forEach(doc => {
          clientes[doc.id] = doc.data().nombre;
        });

        // Mapear equipos con nombre del cliente
        todosLosEquipos = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            nombreCliente: clientes[data.clienteId] || "Cliente no encontrado"
          };
        });

        // Mostrar todos los equipos
        mostrarEquipos(todosLosEquipos);
        
      } catch (error) {
        console.error("Error al cargar inventario:", error);
        document.getElementById("lista-equipos").innerHTML = 
          '<p class="text-danger text-center">‚ùå Error al cargar datos. Intenta de nuevo m√°s tarde.</p>';
      }
    }

    // ==========================================
    // ‚úÖ 4. Mostrar equipos en pantalla
    // ==========================================
    function mostrarEquipos(equipos) {
      const lista = document.getElementById("lista-equipos");
      lista.innerHTML = '';

      // Actualizar contador
      document.getElementById("contador-equipos").textContent = equipos.length;

      if (equipos.length === 0) {
        lista.innerHTML = '<p class="text-muted text-center">No se encontraron equipos.</p>';
        return;
      }

      equipos.forEach(eq => {
        const div = document.createElement("div");
        div.className = "equipo-item";
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">${eq.tipo} (${eq.serial})</h6>
            <span class="badge bg-primary">${eq.ram}</span>
          </div>
          <p class="mb-1"><strong>Cliente:</strong> ${eq.nombreCliente} (${eq.clienteId})</p>
          <p class="mb-1"><strong>Marca/Modelo:</strong> ${eq.marca || 'N/A'} ${eq.modelo || 'N/A'}</p>
          <p class="mb-1"><strong>SO:</strong> ${eq.sistemaOperativo || 'N/A'}</p>
          <p class="mb-1"><strong>Discos:</strong></p>
          <ul class="mb-2" style="padding-left: 20px; font-size: 0.9rem;">
            ${eq.discos?.map(d => `<li>${d.tipo} ${d.capacidad}${d.particion ? ' ('+d.particion+')' : ''}</li>`).join('') || '<li>No especificado</li>'}
          </ul>
          <div class="text-muted small">
          Creado por: ${(eq.creadoPor ? eq.creadoPor.split('@')[0] : 'Desconocido')} | 
          √öltima modificaci√≥n: ${(eq.modificadoPor ? eq.modificadoPor.split('@')[0] : (eq.creadoPor ? eq.creadoPor.split('@')[0] : 'No registrada'))}
          </div>
        `;
        lista.appendChild(div);
      });
    }

    // ==========================================
    // ‚úÖ 5. Aplicar filtros
    // ==========================================
    function aplicarFiltros() {
      const cliente = document.getElementById("filtro-cliente").value.trim().toUpperCase();
      const tipo = document.getElementById("filtro-tipo").value;
      const so = document.getElementById("filtro-so").value;
      const ram = document.getElementById("filtro-ram").value;

      let filtrados = [...todosLosEquipos];

      if (cliente) {
        filtrados = filtrados.filter(e => 
          e.clienteId.includes(cliente) || 
          e.nombreCliente.toUpperCase().includes(cliente)
        );
      }
      if (tipo) {
        filtrados = filtrados.filter(e => e.tipo === tipo);
      }
      if (so) {
        filtrados = filtrados.filter(e => e.sistemaOperativo === so);
      }
      if (ram) {
        filtrados = filtrados.filter(e => e.ram === ram);
      }

      mostrarEquipos(filtrados);
    }

    // ==========================================
    // ‚úÖ 6. Limpiar filtros
    // ==========================================
    function limpiarFiltros() {
      document.getElementById("filtro-cliente").value = '';
      document.getElementById("filtro-tipo").value = '';
      document.getElementById("filtro-so").value = '';
      document.getElementById("filtro-ram").value = '';
      mostrarEquipos(todosLosEquipos);
    }

    // ==========================================
    // ‚úÖ 7. Exportar a Excel
    // ==========================================
    function exportarAExcel() {
      if (todosLosEquipos.length === 0) {
        alert("No hay datos para exportar.");
        return;
      }

      const data = todosLosEquipos.map(eq => ({
        'Serial': eq.serial,
        'Tipo': eq.tipo,
        'Cliente ID': eq.clienteId,
        'Cliente': eq.nombreCliente,
        'Marca': eq.marca || '',
        'Modelo': eq.modelo || '',
        'RAM': eq.ram || '',
        'Sistema Operativo': eq.sistemaOperativo || '',
        'Discos': eq.discos?.map(d => `${d.tipo} ${d.capacidad}${d.particion ? ' ('+d.particion+')' : ''}`).join(', ') || '',
        'Estado': eq.estado || '',
        'Creado por': eq.creadoPor.split('@')[0],
        'Fecha': eq.fechaIncorporacion?.toDate().toLocaleDateString() || 'N/A'
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Inventario T√©cnico");
      
      const fecha = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `inventario-coreltech-${fecha}.xlsx`);
    }
  </script>
</body>
</html>