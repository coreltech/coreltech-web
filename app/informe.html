<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe T√©cnico ‚Äì CorelTech</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  
  <style>
  /* ================================
   DISE√ëO PROFESIONAL PARA INFORME T√âCNICO
   ================================ */
body, html {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  background-color: #f8f9fa;
  color: #212529;
}

/* Contenedor A4 */
.report-container {
  background: white;
  width: 21cm;
  min-height: 29.7cm;
  margin: 0 auto;
  padding: 2cm;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
  position: relative;
  box-sizing: border-box;
}

/* Encabezado con logo */
.header {
  text-align: center;
  border-bottom: 3px solid #0d6efd;
  padding-bottom: 20px;
  margin-bottom: 30px;
}
.header h2 {
  color: #0d6efd;
  font-weight: 700;
  font-size: 1.8rem;
}
.header p {
  margin: 5px 0 0;
  color: #495057;
  font-size: 1rem;
}

/* T√≠tulos de secci√≥n */
.section-title {
  background-color: #0d6efd;
  color: white;
  padding: 10px 15px;
  border-radius: 6px;
  font-size: 1.1rem;
  font-weight: 600;
  margin: 30px 0 15px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Tarjetas de datos */
.data-card {
  background: #f8f9fa;
  border-left: 4px solid #0d6efd;
  padding: 12px 15px;
  margin-bottom: 15px;
  border-radius: 4px;
  font-size: 0.95rem;
}
.data-card strong {
  color: #495057;
  min-width: 120px;
  display: inline-block;
}

/* Tablas para equipos y discos */
.table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
  font-size: 0.9rem;
}
.table th, .table td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}
.table th {
  background-color: #0d6efd;
  color: white;
  font-weight: 600;
}
.table tr:hover {
  background-color: #f1f3f5;
}

/* Listas */
ul {
  padding-left: 20px;
  margin: 10px 0;
}
ul li {
  margin-bottom: 6px;
}

/* Footer */
.footer {
  margin-top: 50px;
  text-align: center;
  padding-top: 20px;
  border-top: 1px dashed #ccc;
  color: #6c757d;
  font-size: 0.9rem;
}
.footer .verification {
  font-family: monospace;
  font-size: 1.1rem;
  letter-spacing: 1px;
  color: #0d6efd;
  margin-top: 5px;
}

/* Fotos */
.fotos-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 15px 0;
}
.foto-miniatura {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border: 2px solid #dee2e6;
  border-radius: 8px;
}

/* Botones (no se imprimen) */
.no-print {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 12px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  z-index: 1000;
  text-align: center;
  width: 90%;
  max-width: 500px;
  border: 1px solid #ddd;
}
.btn {
  margin: 0 5px;
}

/* No imprimir botones */
@media print {
  .no-print { display: none; }
  body, html { width: auto; height: auto; }
  .report-container {
    box-shadow: none;
    margin: 0;
    padding: 0.5in;
  }
}
.watermark {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 100px;
  color: rgba(13, 110, 253, 0.08);
  font-weight: bold;
  pointer-events: none;
  z-index: -1;
  white-space: nowrap;
}
</style>
</head>
<body>

  <!-- ================================
       CONTENIDO DEL INFORME (A4)
       ================================ -->
  <div class="report-container" id="report-content">
   <div class="watermark">‚úÖ ENTREGADO</div> 
    
    <!-- Encabezado con logo -->
<div class="header d-flex align-items-center">
  <div class="me-4">
    <img src="/assets/img/logo.webp" alt="Logo CorelTech" style="height: 60px; object-fit: contain;">
  </div>
  <div class="text-center flex-grow-1">
    <h2>üìÑ Informe T√©cnico</h2>
    <p><strong>Caso:</strong> <span id="caso-id">CT-2025-001</span> | <strong>Fecha:</strong> <span id="fecha">05/04/2025</span></p>
  </div>
</div>

<!-- Cliente y T√©cnico -->
<div class="row">
  <div class="col-6">
    <div class="data-card">
      <strong>Cliente:</strong> <span id="cliente-nombre">Cargando...</span><br>
      <strong>ID:</strong> <span id="cliente-id">-</span><br>
      <strong>Contacto:</strong> <span id="cliente-contacto">-</span><br>
      <strong>Direcci√≥n:</strong> <span id="cliente-direccion">-</span>
    </div>
  </div>
  <div class="col-6">
    <div class="data-card">
      <strong>T√©cnico:</strong> <span id="tecnico-nombre">Carlos M.</span><br>
      <strong>Estado:</strong> <span id="caso-estado" class="badge bg-success">Entregado</span><br>
      <strong>Pr√≥xima revisi√≥n:</strong> <span id="proxima-revision">05/10/2025</span>
    </div>
  </div>
</div>

<!-- Equipos Atendidos -->
<div class="section-title">üñ•Ô∏è Equipos Atendidos</div>
<div id="seccion-equipos">
  <!-- Se llenar√° con JS -->
  <p class="text-muted">Cargando equipos...</p>
</div>

<!-- Diagn√≥stico T√©cnico por Equipo -->
<div class="section-title">üîß Diagn√≥stico T√©cnico por Equipo</div>
<div id="seccion-diagnostico-equipo">
  <p class="text-muted">Cargando diagn√≥stico...</p>
</div>

<!-- Diagn√≥stico General de la Visita -->
<div class="section-title">üåê Diagn√≥stico General de la Visita</div>
<div class="data-card">
  <strong>Infraestructura de Red:</strong>
  <p id="diagnostico-red">Cargando...</p>
  <strong>Observaciones Generales:</strong>
  <p id="observaciones-generales">Cargando...</p>
</div>

<!-- Trabajo Realizado -->
<div class="section-title">üõ†Ô∏è Trabajo Realizado</div>
<ul id="acciones-realizadas"></ul>

<!-- Recomendaciones -->
<div class="section-title">üìÖ Recomendaciones</div>
<ul id="recomendaciones-lista"></ul>

<!-- Fotos del Servicio -->
<div class="section-title">üì∏ Evidencia Fotogr√°fica</div>
<div id="fotos-container" class="fotos-container">
  <!-- Se llenar√° con JS -->
</div>

<!-- Footer -->
<div class="footer">
  <p>¬© 2025 CorelTech ‚Äì Soporte t√©cnico profesional en hardware, software y redes.</p>
  <p class="verification">C√≥digo de verificaci√≥n: <span id="caso-id-footer">CT-2025-001</span></p>
</div>

  </div>

  <!-- ================================
       BOTONES DE ACCI√ìN
       ================================ -->
  <!-- Botones -->
<!-- Botones -->
<div class="no-print text-center my-4">
  <button onclick="window.history.back()" class="btn btn-secondary btn-lg mx-3">
    <i class="bi bi-arrow-left"></i> Volver
  </button>
  <button onclick="generarPDF()" class="btn btn-primary btn-lg mx-3">
    <i class="bi bi-download"></i> Descargar PDF
  </button>
  <button onclick="enviarPorTelegram()" class="btn btn-success btn-lg mx-3">
    <i class="bi bi-send"></i> Enviar por Telegram
  </button>
</div>

  <!-- ================================
       SCRIPTS
       ================================ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="/firebase-config.js"></script>
  <script src="/app/js/auth.js"></script>

  <script>
    // ================================
    // INICIALIZACI√ìN
    // ================================
    const urlParams = new URLSearchParams(window.location.search);
    const casoId = urlParams.get('id');

    if (!casoId) {
      alert("No se especific√≥ un caso.");
      window.history.back();
    }

    // ================================
    // CARGAR DATOS DEL CASO
    // ================================
    async function cargarInforme() {
  const db = firebase.firestore();
  const casoRef = db.collection("casos").doc(casoId);
  const doc = await casoRef.get();
  if (!doc.exists) {
    alert("Caso no encontrado.");
    return;
  }
  const data = doc.data();
  const clienteDoc = await db.collection("clientes").doc(data.clienteId).get();
  const clienteData = clienteDoc.exists ? clienteDoc.data() : {};

  // Datos b√°sicos
  document.getElementById("caso-id").textContent = casoId;
  document.getElementById("caso-id-footer").textContent = casoId;
  document.getElementById("fecha").textContent = new Date().toLocaleDateString();
  document.getElementById("cliente-nombre").textContent = clienteData.nombre || "No disponible";
  document.getElementById("cliente-id").textContent = data.clienteId;
  document.getElementById("cliente-contacto").textContent = clienteData.telefono || "No disponible";
  document.getElementById("cliente-direccion").textContent = clienteData.direccion || "No especificada";
  document.getElementById("tecnico-nombre").textContent = data.tecnicoAsignado.split('@')[0];
  document.getElementById("caso-estado").textContent = data.estado || "No especificado";

  // Pr√≥xima revisi√≥n (6 meses)
  const seisMeses = new Date();
  seisMeses.setMonth(seisMeses.getMonth() + 6);
  document.getElementById("proxima-revision").textContent = seisMeses.toLocaleDateString();

  // Equipos
  const seccionEquipos = document.getElementById("seccion-equipos");
  seccionEquipos.innerHTML = '<table class="table"><thead><tr><th>Tipo</th><th>Marca/Modelo</th><th>Serial</th><th>RAM</th><th>Discos</th><th>SO</th></tr></thead><tbody></tbody></table>';
  const tbody = seccionEquipos.querySelector("tbody");

  for (const serial of data.equipos) {
    const equipoDoc = await db.collection("equipos").doc(serial).get();
    if (equipoDoc.exists) {
      const eq = equipoDoc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${eq.tipo || 'Equipo'}</td>
        <td>${eq.marca || ''} ${eq.modelo || ''}</td>
        <td>${serial}</td>
        <td>${eq.ram || 'N/A'}</td>
        <td>
          <ul style="margin:0; padding-left:15px; font-size:0.9rem;">
            ${eq.discos?.map(d => `<li>${d.tipo} ${d.capacidad}${d.particion ? ' ('+d.particion+')' : ''}</li>`).join('') || '<li>No especificado</li>'}
          </ul>
        </td>
        <td>${eq.sistemaOperativo || 'N/A'}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Diagn√≥stico por equipo
  const seccionDiag = document.getElementById("seccion-diagnostico-equipo");
  seccionDiag.innerHTML = '';
  for (const serial of data.equipos) {
    const equipoDoc = await db.collection("equipos").doc(serial).get();
    if (equipoDoc.exists) {
      const eq = equipoDoc.data();
      const div = document.createElement("div");
      div.classList.add("data-card");
      div.innerHTML = `
        <strong>Equipo: ${eq.tipo} (${serial})</strong><br>
        <p>${eq.diagnostico?.tecnico || 'No se registr√≥ diagn√≥stico t√©cnico.'}</p>
      `;
      seccionDiag.appendChild(div);
    }
  }

  // Diagn√≥stico general
  document.getElementById("diagnostico-red").textContent = data.diagnostico?.red || "No especificado";
  document.getElementById("observaciones-generales").textContent = data.diagnostico?.observacionesGenerales || "No especificado";

  // Trabajo realizado (por equipo)
  const accionesList = document.getElementById("acciones-realizadas");
  accionesList.innerHTML = '';
  for (const serial of data.equipos) {
    const equipoDoc = await db.collection("equipos").doc(serial).get();
    if (equipoDoc.exists) {
      const eq = equipoDoc.data();
      const li = document.createElement("li");
      li.innerHTML = `<strong>${serial}:</strong> ${eq.trabajoRealizado || 'No especificado'}`;
      accionesList.appendChild(li);
    }
  }

  // Recomendaciones
  const recomendacionesList = document.getElementById("recomendaciones-lista");
  recomendacionesList.innerHTML = '';
  for (const serial of data.equipos) {
    const equipoDoc = await db.collection("equipos").doc(serial).get();
    if (equipoDoc.exists) {
      const eq = equipoDoc.data();
      const li = document.createElement("li");
      li.innerHTML = `<strong>${serial}:</strong> ${eq.recomendaciones || 'No especificado'}`;
      recomendacionesList.appendChild(li);
    }
  }

  // Fotos
  const fotosContainer = document.getElementById("fotos-container");
  fotosContainer.innerHTML = '';
  if (data.diagnostico?.fotos?.length) {
    data.diagnostico.fotos.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.classList.add("foto-miniatura");
      img.onclick = () => window.open(url, '_blank');
      fotosContainer.appendChild(img);
    });
  } else {
    fotosContainer.innerHTML = '<p class="text-muted">No se subieron fotos.</p>';
  }
}

    // ================================
    // FORMATO DE ESTADOS
    // ================================
    function formatearEstado(estado) {
      const map = {
        solicitado: "Solicitado",
        asignado: "Asignado",
        diagnostico: "Diagn√≥stico",
        presupuestado: "Presupuestado",
        aprobado: "Aprobado",
        en_reparacion: "En reparaci√≥n",
        finalizado: "Finalizado",
        entregado: "Entregado"
      };
      return map[estado] || estado;
    }

    // ================================
    // LLENAR DIAGN√ìSTICO
    // ================================
    function llenarDiagnostico(diag) {
      const hw = document.getElementById("diag-hardware");
      const sw = document.getElementById("diag-software");
      const red = document.getElementById("diag-redes");

      hw.innerHTML = sw.innerHTML = red.innerHTML = '';

      if (diag.hardware?.limpiezaRealizada) hw.innerHTML += "<li>Limpieza interna completada</li>";
      if (hw.innerHTML === '') hw.innerHTML = "<li>Sin observaciones</li>";

      if (!diag.software?.malwareDetectado) sw.innerHTML += "<li>Escaneo antivirus: sin malware</li>";
      if (sw.innerHTML === '') sw.innerHTML = "<li>Sin observaciones</li>";

      if (diag.redes?.internet) red.innerHTML += "<li>Conexi√≥n a internet estable</li>";
      if (red.innerHTML === '') red.innerHTML = "<li>Sin observaciones</li>";
    }

    // ================================
    // GENERAR PDF (CORREGIDO)
    // ================================
    function generarPDF() {
  const element = document.getElementById("report-content");

  // Pre-cargar el logo
  const img = new Image();
  img.src = '/assets/img/logo.webp';
  img.onload = () => {
    const opt = {
      margin: 1,
      filename: `informe-coreltech-${casoId}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 3,
        useCORS: true,
        logging: false,
        width: 816,
        height: 1056,
        scrollY: 0,
        windowWidth: 816,
        windowHeight: 1056
      },
      jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
  };

  img.onerror = () => {
    console.warn("‚ö†Ô∏è No se pudo cargar el logo. Aseg√∫rate de que /assets/img/logo.webp exista.");
    // Igual genera el PDF sin esperar
    const opt = {
      margin: 1,
      filename: `informe-coreltech-${casoId}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 3, useCORS: true },
      jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  };
}
    function generarPDF() {
  const element = document.getElementById("report-content");

  const opt = {
    margin: 0, // El contenedor ya tiene 2cm de padding
    filename: `informe-coreltech-${casoId}.pdf`,
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: {
      scale: 3,
      useCORS: true,
      logging: false,
      width: 816,  // Aproximado para 21cm a 96dpi
      height: 1056, // Aproximado para 29.7cm
      scrollY: 0,
      windowWidth: 816,
      windowHeight: 1056,
      x: 0,
      y: 0
    },
    jsPDF: {
      unit: 'pt',
      format: [595.28, 841.89], // Tama√±o A4 en puntos
      orientation: 'portrait'
    },
    pagebreak: { mode: ['avoid-break', 'css', 'legacy'] }
  };

  html2pdf()
    .set(opt)
    .from(element)
    .save();
}

    // ================================
    // ENVIAR POR TELEGRAM
    // ================================
    async function enviarPorTelegram() {
      const element = document.getElementById("report-content");
      const opt = {
        margin: 0,
        filename: `informe-coreltech-${casoId}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: {
          scale: 3,
          useCORS: true,
          width: element.offsetWidth,
          height: element.offsetHeight
        },
        jsPDF: {
          unit: 'pt',
          format: [595.28, 841.89],
          orientation: 'portrait'
        }
      };

      try {
        const pdf = await html2pdf().from(element).set(opt).output('blob');
        const formData = new FormData();
        const token = '8276946283:AAGXHKx8x3_uqifGTCqMO-j7K7LXcXoNOE8'; // ‚Üê Tu token real
        const chat_id = '7523354646'; // ‚Üê Tu chat_id real
        const caption = `üìÑ Informe t√©cnico ${casoId}\nCliente: ${document.getElementById("cliente-id").textContent}`;

        formData.append('chat_id', chat_id);
        formData.append('caption', caption);
        formData.append('document', pdf, `informe-${casoId}.pdf`);

        const response = await fetch(`https://api.telegram.org/bot${token}/sendDocument`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.ok) {
          alert("‚úÖ Informe enviado por Telegram.");
        } else {
          alert(`‚ùå Error: ${result.description}`);
        }
      } catch (error) {
        alert("‚ùå Error de red: " + error.message);
      }
    }

    // ================================
    // CARGAR AL INICIAR
    // ================================
    console.log("üìÑ Cargando informe t√©cnico:", casoId);
    window.onload = cargarInforme;
  </script>
</body>
</html>