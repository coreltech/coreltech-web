<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mantenimiento ‚Äì CorelTech</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .alerta {
      border-left: 5px solid #fd7e14;
      background: #fff3cd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }
    .urgente {
      border-left-color: #dc3545;
      background: #f8d7da;
    }
  </style>
</head>
<body class="p-4">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold">üõ†Ô∏è Alertas de Mantenimiento Preventivo</h1>
      <button class="btn btn-secondary" onclick="window.history.back()">‚Üê Volver</button>
    </div>

    <!-- Resumen -->
    <div class="card mb-4">
      <div class="card-body">
        <p class="mb-0">
          <i class="bi bi-info-circle"></i> 
          Este listado muestra clientes que no han tenido servicio t√©cnico en los √∫ltimos <strong>6 meses</strong>.
          Recomendamos contactarlos para ofrecer mantenimiento preventivo.
        </p>
      </div>
    </div>

    <!-- Lista de Alertas -->
    <div class="card">
      <div class="card-header bg-warning text-white">
        <h5>‚ö†Ô∏è Clientes que necesitan mantenimiento</h5>
      </div>
      <div class="card-body">
        <div id="lista-alertas">
          <p class="text-muted">Cargando alertas...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="/firebase-config.js"></script>
  <script src="/app/js/auth.js"></script>

  <script>
    // Cargar alertas al iniciar
    window.onload = async () => {
      const db = firebase.firestore();
      const seisMesesAtras = new Date();
      seisMesesAtras.setMonth(seisMesesAtras.getMonth() - 6);

      const snapshot = await db.collection("clientes").get();
      const clientes = snapshot.docs.map(d => d.data());

      const alertas = clientes.filter(c => {
        if (!c.ultimoServicio?.toDate) return false;
        return c.ultimoServicio.toDate() < seisMesesAtras;
      });

      const lista = document.getElementById("lista-alertas");
      lista.innerHTML = '';

      if (alertas.length === 0) {
        lista.innerHTML = '<p class="text-success">‚úÖ No hay clientes pendientes de mantenimiento.</p>';
        return;
      }

      alertas.sort((a, b) => a.ultimoServicio.toDate() - b.ultimoServicio.toDate());

      alertas.forEach(cliente => {
        const ultimaVisita = cliente.ultimoServicio.toDate().toLocaleDateString();
        const dias = Math.floor((Date.now() - cliente.ultimoServicio.toDate()) / (1000 * 60 * 60 * 24));
        const esUrgente = dias > 365;

        const div = document.createElement("div");
        div.className = `alerta ${esUrgente ? 'urgente' : ''}`;
        div.innerHTML = `
          <div class="d-flex justify-content-between">
            <h6>${cliente.nombre} (${cliente.nombre})</h6>
            <span class="badge ${esUrgente ? 'bg-danger' : 'bg-warning'}">${dias} d√≠as sin servicio</span>
          </div>
          <p class="mb-1"><strong>√öltima visita:</strong> ${ultimaVisita}</p>
          <p class="mb-1"><strong>Tel√©fono:</strong> ${cliente.telefono}</p>
          <p class="mb-0 text-muted">Equipos registrados: ${cliente.equipos?.length || 0}</p>
        `;
        lista.appendChild(div);
      });
    };
  </script>
</body>
</html>